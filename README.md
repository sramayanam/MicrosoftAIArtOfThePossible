# Airlines Analytics Agent — Power Apps Code App

A chat interface for a **Copilot Studio agent** that explores airline industry data (routes, airports, carriers, passengers, revenue) and renders charts — built as a Power Apps Code App with React + TypeScript + Vite.

## Features

- **Instant welcome greeting** describing agent capabilities
- **Copilot Studio connector** via `@microsoft/power-apps` SDK
- **Markdown rendering** with tables, bold, lists, and inline images
- **Chart images** rendered inside Power Apps CSP restrictions
- **Sample prompts sidebar** with pre-built airline data queries
- **New Chat** resets conversation without a page reload

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Framework | React 19 + TypeScript 5.9 |
| Bundler | Vite 7 + `@microsoft/power-apps-vite` |
| Connector SDK | `@microsoft/power-apps` v1.0.3 |
| Markdown | `react-markdown` + `remark-gfm` |
| Platform | Power Apps Code Apps |
| Agent | Copilot Studio — Airlines Agent V1 |

## Project Structure

```
src/
├── App.tsx                  # Root — renders Header + Chat
├── main.tsx                 # Entry point
├── index.css                # All styles (sidebar, chat, responsive)
├── components/
│   ├── Chat.tsx             # Chat orchestrator, welcome message, lazy agent init
│   ├── MessageList.tsx      # Message rendering + CSP-safe image processing
│   ├── MessageInput.tsx     # Text input + send button
│   ├── Header.tsx           # App header bar
│   └── SamplePrompts.tsx    # Sidebar with clickable sample prompts
├── services/
│   ├── ChatService.ts       # Interface: startConversation, sendMessage, endConversation
│   ├── PowerChatService.ts  # Calls Copilot Studio via connector SDK
│   └── index.ts             # Barrel exports
├── generated/               # Auto-generated by `pac code add-data-source`
│   └── index.ts             # Typed service + model for connector operations
└── types/
    └── chat.ts              # ChatMessage type
```

## Getting Started

### Prerequisites

- Node.js 18+
- PAC CLI (via Power Platform VS Code extension)
- A Power Apps environment with the Copilot Studio connector configured

### Development

```bash
npm install
npm run dev          # Vite dev server at http://localhost:3000
```

### Build & Deploy

```bash
npm run build        # TypeScript check + Vite production build → dist/
pac code push        # Deploy to Power Apps
```

## Architecture

The app runs entirely client-side with no backend server. Auth is handled by the Power Apps platform.

### Data Connector — Microsoft Copilot Studio

The app uses the **`shared_microsoftcopilotstudio`** connector, configured in `power.config.json` with a shared connection. The typed service layer is auto-generated by `pac code add-data-source` into `src/generated/`, providing a `MicrosoftCopilotStudioService` class with static methods for all 14 connector operations.

Each method calls `getClient(dataSourcesInfo).executeAsync()` from `@microsoft/power-apps/data`. The SDK resolves the connection reference, authenticates using the user's Power Apps session, and routes calls through the connector's APIM gateway — no auth code needed in the app.

**Operation used:**

| Operation | Response |
|-----------|----------|
| `ExecuteCopilotAsyncV2` | `{ responses: string[], conversationId, completed }` |

The call shape:

```typescript
ExecuteCopilotAsyncV2(
  '<your_agent_schema_name>',                   // agent schema name
  { message: '...', notificationUrl: '...' },  // notificationUrl is required but unused
  conversationId?,                              // undefined on first turn
)
```

### PowerChatService

`PowerChatService` implements the `ChatService` interface (`startConversation`, `sendMessage`, `endConversation`), decoupling the UI from connector details.

Key behaviors:

- **Conversation tracking** — Stores `conversationId` across turns. First call goes without one; subsequent calls pass it via `x_ms_conversation_id` so the agent maintains context.
- **Resilient parsing** — `parseResponse()` handles three casings of the conversation ID field (`conversationId`, `conversationID`, `ConversationId`) and unwraps `result.data` vs `result` depending on SDK response shape.
- **Lazy initialization** — `startConversation()` is deferred to the first user message. The app shows a local welcome message instantly with zero network latency.

### Chart Rendering

The agent returns chart images as standard markdown (`![alt](https://...)`). These are rendered directly by `react-markdown` as inline `<img>` tags — no special processing needed.
